# TASKS

## T-201 MVP2 Local Closure and Stability
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - Stabilize local dev on `http://localhost:3000`.
  - Make `tests/diagnostic.spec.ts` deterministic and passing on Chromium.
  - Deliver MVP2 shell flow closure (`/report -> /unlock -> /repair -> /repair/day/1 -> /repair/submit -> /repair/submit/result -> /retest -> /upsell`).
  - Make `/api/analyze` 429 handling controllable (retry/backoff + logs + duplicate burst protection).
- **Change Points**:
  - Process and runtime scripts: single-instance dev on port 3000.
  - Test hardening: network audit assertions and readiness stability.
  - Frontend anti-repeat submit hardening for diagnosis trigger.
  - Backend `/api/analyze`: exponential backoff retries, retry caps, idempotent TTL cache, explainable logs.
  - MVP2 shell pages and routing completion with placeholder copy only.
  - Delivery docs: PRD decision log + walkthrough.
- **Acceptance (DoD)**:
  - Only one listener PID on local port `3000`, and dev remains on `http://localhost:3000`.
  - One diagnosis trigger produces exactly one `POST /api/analyze` request.
  - `npx playwright test tests/diagnostic.spec.ts --project=chromium` passes.
  - Unlock code `123456` gates `/repair` flow correctly.
  - 3 rapid clicks still produce one analysis request; transient 429 uses bounded backoff and clear feedback.
- **Expected Impacted Files**:
  - `playwright.config.ts`
  - `tests/diagnostic.spec.ts`
  - `app/processing/page.tsx`
  - `app/api/analyze/route.ts`
  - `app/report/page.tsx`
  - `app/repair/submit/page.tsx`
  - `app/repair/submit/result/page.tsx`
  - `docs/PRD.md`
  - `docs/TASKS.md`
  - `docs/walkthrough.md`
- **Rollback Plan**:
  - Revert commit group by module (A/B/C/D/E) in reverse order.
  - Disable analyze retry/cache by removing helper functions in `app/api/analyze/route.ts`.
  - Restore previous submit page behavior by reverting `app/repair/submit/page.tsx` and deleting result page.
- **Execution Notes**:
  - `3000` 已固定单监听，`tests/diagnostic.spec.ts` 已升级并通过（Chromium）。
  - `/api/analyze` 已加入可解释重试退避、同载荷并发合并、TTL 缓存命中日志。
  - MVP2 壳子闭环已打通到独立结果页 `/repair/submit/result`。

## T-202 7天修复内容包
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - 将 MVP2 补强为可售卖“交付闭环”：内容可交付、复检标签稳定、支持无 API 演示模式。
- **Change Points**:
  - 补齐三条错因线各 7 天内容，清空占位文案，统一口语化风格。
  - 修正复检标签传递链路，确保 `/retest/result` 不出现“未指定错因”。
  - 增加 `/processing?demo=1` 本地夹具模式，跳过模型调用完成演示。
- **Not-to-do**:
  - 不修改 `/api/analyze`。
  - 不新增外部 API 调用。
  - 不改诊断请求次数策略（1 click = 1 request）。
- **Acceptance (DoD)**:
  - 三条错因线 21 天内容全部可直接展示，无占位字样。
  - 复检流程保留选中错因线直达结果页，标签显示稳定。
  - `?demo=1` 模式不走模型请求也能完成演示闭环。
  - `npx playwright test tests/diagnostic.spec.ts --project=chromium` 继续 PASS。
- **Impacted Files**:
  - `data/training/repair_7days.ts`
  - `app/processing/page.tsx`
  - `app/retest/page.tsx`
  - `app/retest/result/page.tsx`
  - `app/repair/day/[id]/page.tsx`
  - `docs/PRD.md`
  - `docs/TASKS.md`

## T-203 复检对比+续费入口
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - 把复检做成可交付静态闭环：按错因线选择 6 题、前端本地判定、结果页给出命中率和去向建议。
- **Change Points**:
  - 新增/补全 `data/retest_6q.ts` 静态题包（3 条错因线，各 6 题）。
  - 每题包含：题干、选项、正确项、错因解释一句话。
  - `/retest` 支持：选错因线 -> 答题 -> 本地判定 -> 跳转结果页。
  - `/retest/result` 展示：命中率 + 建议（再练一轮 / 进入 upsell）。
- **Acceptance (DoD)**:
  - 全流程不新增外部 API 调用。
  - 不改 `/api/analyze` 和诊断请求次数策略。
  - `npx playwright test tests/diagnostic.spec.ts --project=chromium` 继续 PASS。
- **Impacted Files**:
  - `data/retest_6q.ts`
  - `app/retest/page.tsx`
  - `app/retest/result/page.tsx`
  - `docs/PRD.md`
  - `docs/TASKS.md`

## T-204 Report->Unlock->Repair Gate
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - 打通“报告页 -> 解锁页 -> 7天修复”的闭环入口。
- **Change Points**:
  - 报告页增加入口按钮“开始7天修复”。
  - 入口逻辑：未解锁跳 `/unlock?next=/repair`；已解锁直达 `/repair`。
  - 解锁页支持 `next` 参数，解锁成功自动回跳。
- **Acceptance (DoD)**:
  - 报告页点击“开始7天修复”按解锁状态正确分流。
  - 解锁成功后自动回到 `next`（默认 `/repair`）。
  - `npx playwright test tests/diagnostic.spec.ts --project=chromium` 继续 PASS。
- **Impacted Files**:
  - `app/report/page.tsx`
  - `app/unlock/page.tsx`
  - `docs/PRD.md`
  - `docs/TASKS.md`
