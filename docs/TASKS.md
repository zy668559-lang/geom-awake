# TASKS

## T-201 MVP2 Local Closure and Stability
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - Stabilize local dev on `http://localhost:3000`.
  - Make `tests/diagnostic.spec.ts` deterministic and passing on Chromium.
  - Deliver MVP2 shell flow closure (`/report -> /unlock -> /repair -> /repair/day/1 -> /repair/submit -> /repair/submit/result -> /retest -> /upsell`).
  - Make `/api/analyze` 429 handling controllable (retry/backoff + logs + duplicate burst protection).
- **Change Points**:
  - Process and runtime scripts: single-instance dev on port 3000.
  - Test hardening: network audit assertions and readiness stability.
  - Frontend anti-repeat submit hardening for diagnosis trigger.
  - Backend `/api/analyze`: exponential backoff retries, retry caps, idempotent TTL cache, explainable logs.
  - MVP2 shell pages and routing completion with placeholder copy only.
  - Delivery docs: PRD decision log + walkthrough.
- **Acceptance (DoD)**:
  - Only one listener PID on local port `3000`, and dev remains on `http://localhost:3000`.
  - One diagnosis trigger produces exactly one `POST /api/analyze` request.
  - `npx playwright test tests/diagnostic.spec.ts --project=chromium` passes.
  - Unlock code `123456` gates `/repair` flow correctly.
  - 3 rapid clicks still produce one analysis request; transient 429 uses bounded backoff and clear feedback.
- **Expected Impacted Files**:
  - `playwright.config.ts`
  - `tests/diagnostic.spec.ts`
  - `app/processing/page.tsx`
  - `app/api/analyze/route.ts`
  - `app/report/page.tsx`
  - `app/repair/submit/page.tsx`
  - `app/repair/submit/result/page.tsx`
  - `docs/PRD.md`
  - `docs/TASKS.md`
  - `docs/walkthrough.md`
- **Rollback Plan**:
  - Revert commit group by module (A/B/C/D/E) in reverse order.
  - Disable analyze retry/cache by removing helper functions in `app/api/analyze/route.ts`.
  - Restore previous submit page behavior by reverting `app/repair/submit/page.tsx` and deleting result page.
- **Execution Notes**:
  - `3000` 已固定单监听，`tests/diagnostic.spec.ts` 已升级并通过（Chromium）。
  - `/api/analyze` 已加入可解释重试退避、同载荷并发合并、TTL 缓存命中日志。
  - MVP2 壳子闭环已打通到独立结果页 `/repair/submit/result`。

## T-202 7天修复内容包
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - 补全三条错因线（`画线想不到/条件关系乱/证明写不出`）各 7 天静态训练内容。
- **Not-to-do**:
  - 不新增任何外部 API。
  - 不改 `/api/analyze` 链路。
  - 不改“1 click = 1 request”请求次数策略。
- **Acceptance (DoD)**:
  - 内容包中 21 天内容全部具备 `command`、`microPractice`、`reflectionPrompt`。
  - `/repair` 可切换三条错因线，并进入 `/repair/day/1..7` 正常显示内容。
  - `tests/diagnostic.spec.ts` 在 Chromium 继续 PASS。
- **Impacted Files**:
  - `data/training/repair_7days.ts`
  - `docs/PRD.md`
  - `docs/TASKS.md`

## T-203 复检对比+续费入口
- **Status**: Completed
- **Owner**: Codex
- **Goal**:
  - 把复检做成可交付静态闭环：按错因线选择 6 题、前端本地判定、结果页给出命中率和去向建议。
- **Change Points**:
  - 新增/补全 `data/retest_6q.ts` 静态题包（3 条错因线，各 6 题）。
  - 每题包含：题干、选项、正确项、错因解释一句话。
  - `/retest` 支持：选错因线 -> 答题 -> 本地判定 -> 跳转结果页。
  - `/retest/result` 展示：命中率 + 建议（再练一轮 / 进入 upsell）。
- **Acceptance (DoD)**:
  - 全流程不新增外部 API 调用。
  - 不改 `/api/analyze` 和诊断请求次数策略。
  - `npx playwright test tests/diagnostic.spec.ts --project=chromium` 继续 PASS。
- **Impacted Files**:
  - `data/retest_6q.ts`
  - `app/retest/page.tsx`
  - `app/retest/result/page.tsx`
  - `docs/PRD.md`
  - `docs/TASKS.md`
